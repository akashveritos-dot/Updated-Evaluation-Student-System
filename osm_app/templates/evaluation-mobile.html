<!DOCTYPE html>
<html lang="en">

<head>
  {% load static %}
  <meta charset="UTF-8">
  <title>Mobile</title>
  <!-- <meta name="viewport" content="width=device-width, initial-scale=1"> -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- Bootstrap 5 CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">
  <link rel="stylesheet" href="{% static 'style.css' %}">
  <link rel="stylesheet" href="{% static 'mobile-style.css' %}">
  {% csrf_token %}
  {{ questions|json_script:"questionsData" }}
  {{ status_map|json_script:"statusData" }}
  {{ images|json_script:"imagesData" }}
</head>

<body class="bg-danger">
  <i id="custom-cursor" style="position:fixed; pointer-events:none; z-index:9999; display:none;"></i>
  <div id="loader-main"><span class="loader"></span></div>
  
  
  <nav class="navbar navbar-expand-lg navbar-primary bg-primary ">
    <div class="container-fluid">
      <a class="navbar-brand text-light fw-bolder" href="#">VeriEval Marking Panel</a>
      <div class="d-flex align-items-center gap-2">
        <button type="button" class="btn btn-info btn-sm" id="mobileViewBtnMobile" data-bs-toggle="tooltip"
          title="Switch to Mobile View" style="display: none;">
          <i class="bi bi-phone"></i>
        </button>
        <button type="button" class="btn btn-warning btn-sm" id="desktopViewBtnMobile" data-bs-toggle="tooltip"
          title="Switch to Desktop View">
          <i class="bi bi-pc-display-horizontal"></i> Desktop
        </button>
        <button type="button" class="btn btn-info btn-sm" data-bs-toggle="offcanvas" data-bs-target="#helpModal"
          title="Help">
          <i class="bi bi-question-circle"></i>
        </button>
        <button type="button" class="btn btn-success btn-sm" data-bs-toggle="tooltip" title="Support">
          <i class="bi bi-life-preserver"></i>
        </button>
        <button type="button" class="btn btn-danger btn-sm" id="submitEntriesBtn" data-bs-toggle="modal" data-bs-target="#submitEntriesModal" title="Submit Entries">
          <i class="bi bi-send"></i> Submit
        </button>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent"
          aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation"
          style="filter: invert(1);">
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
      <div class="collapse navbar-collapse" id="navbarSupportedContent">
      </div>
    </div>
  </nav>
  <div class="container-fluid">
    <div class="row">
      <!-- Left Section (Slider) -->
      <div class="col-md-12 p-0">
        <style>
          .scroll-container {
            overflow-x: auto;
            white-space: nowrap;
          }

          .scroll-container::-webkit-scrollbar {
            height: 6px;
          }

          .scroll-container::-webkit-scrollbar-thumb {
            background-color: #ccc;
            border-radius: 4px;
          }
          
          /* Ensure desktop switch button is always visible */
          #desktopViewBtnMobile {
            min-width: auto !important;
            flex-shrink: 0 !important;
          }
          
          /* Mobile-specific overrides */
          .container-fluid {
            padding: 0 !important;
          }
          
          .row {
            margin: 0 !important;
          }
          
          .col-md-12 {
            padding: 0 !important;
          }
          
          /* Fix navbar visibility */
          .navbar {
            position: relative !important;
            z-index: 1000 !important;
          }
          
          /* Fix carousel container */
          #sliderCarousel {
            position: relative !important;
            height: auto !important;
            overflow: hidden !important;
          }
          
          .carousel-inner {
            position: relative !important;
            height: auto !important;
          }
          
          .carousel-item {
            position: relative !important;
            height: auto !important;
          }
          
          .carousel-item img {
            width: 100% !important;
            height: auto !important;
            max-height: 60vh !important;
            object-fit: contain !important;
          }
          
          .carousel-item canvas {
            position: absolute !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            pointer-events: auto !important;
          }
          
          /* Fix tools bar */
          .tools-bar {
            position: relative !important;
            bottom: auto !important;
            z-index: 1000 !important;
            border-top: 1px solid #dee2e6 !important;
          }
          
          /* Hide desktop-specific elements */
          .fixed-col {
            display: none !important;
          }
          
          /* Make sure content is visible */
          body {
            visibility: visible !important;
            opacity: 1 !important;
          }
          
          /* Debug info styling */
          .debug-info {
            position: fixed !important;
            top: 10px !important;
            left: 10px !important;
            background: yellow !important;
            padding: 5px !important;
            z-index: 9999 !important;
            font-size: 12px !important;
            border: 1px solid red !important;
          }

          /* Custom Select Button Styling */
          .select-question {
            background: white !important;
            border: 2px solid black !important;
            border-radius: 4px !important;
            padding: 4px !important;
            font-size: 12px !important;
            font-weight: 500 !important;
            color: black !important;
            cursor: pointer !important;
            transition: all 0.2s ease !important;
            display: inline-flex !important;
            align-items: center !important;
            justify-content: center !important;
            width: 24px !important;
            height: 24px !important;
            min-width: 24px !important;
            min-height: 24px !important;
          }

          .select-question:hover {
            background: #f8f9fa !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1) !important;
          }

          .select-question.selected {
            background: black !important;
            color: white !important;
          }

          .select-question .select-icon {
            width: 14px !important;
            height: 14px !important;
            object-fit: contain !important;
          }
        </style>
        <div class="scroll-container bg-light px-2 py-2">
          <div class="d-flex align-items-center flex-nowrap gap-2" style="min-width: max-content;">
            <!-- Page Navigation -->
            <div class="d-flex align-items-center gap-2" role="group" aria-label="Page Navigation">
              <button class="btn btn-sm lh-1 py-2 d-flex align-items-center btn-outline-secondary"
                onclick="goToSlide('prev')">
                <i class="bi bi-chevron-double-left me-1"></i>
              </button>
              <select id="pageSelect" class="form-select form-select-sm w-auto border-dark"
                onchange="goToSlide(this.value)" data-bs-toggle="tooltip" title="Select Page">
                {% for image in images %}
                <option value="{{ forloop.counter0 }}">Page {{ forloop.counter }}</option>
                {% endfor %}
              </select>
              <button class="btn btn-sm lh-1 py-2 d-flex align-items-center btn-outline-secondary"
                onclick="goToSlide('next')">
                <i class="bi bi-chevron-double-right ms-1"></i>
              </button>
            </div>

            <!-- Zoom & Rotate Controls (same IDs as desktop for shared JS) -->
            <div class="btn-group btn-group-sm" role="group" aria-label="Zoom & Rotate">
              <button class="btn btn-sm btn-primary sheets-btn" data-bs-toggle="modal" data-bs-target="#sheetsModal" title="Manage Sheets">
                <i class="bi bi-grid-3x3-gap"></i> Sheets
              </button>
              <button class="btn btn-outline-dark" id="zoomInBtn" data-bs-toggle="tooltip" title="Zoom">
                <i class="bi bi-zoom-in"></i>
              </button>
              <button class="btn btn-outline-secondary" id="rotate-image" data-bs-toggle="tooltip" title="Rotate page">
                <i class="bi bi-arrow-repeat"></i>
              </button>
            </div>

            <!-- Time Taken -->
            <div class="text-muted small fw-semibold btn btn-sm btn-outline-dark" data-bs-toggle="tooltip"
              title="Time spent on evaluation">
              <i class="bi bi-clock-history me-1"></i><span id="timeTaken">00:00:00</span>
            </div>
            <!-- Orientation Controls -->
            <!-- <div class="btn-group" role="group" aria-label="Orientation Controls">
              <button class="btn btn-sm btn-outline-secondary active" id="portraitBtn" data-bs-toggle="tooltip"
                title="Portrait Mode">
                <i class="bi bi-phone"></i>
              </button>
              <button class="btn btn-sm btn-outline-secondary" id="landscapeBtn" data-bs-toggle="tooltip"
                title="Landscape Mode">
                <i class="bi bi-phone-landscape"></i>
              </button>
            </div> -->
          </div>
        </div>
        <div id="sliderCarousel" class="carousel slide" data-bs-ride="false" data-bs-touch="false">
          <div class="carousel-inner">
            {% for image in images %}
            <div class="carousel-item {% if forloop.first %}active{% endif %}">
              <canvas></canvas>
              <img draggable="false" class="magnifiable-image" src="{{ image }}" class="d-block w-100"
                alt="Slide {{ forloop.counter }}">
            </div>
            {% endfor %}
          </div>
          <button class="carousel-control-prev" type="button" data-bs-target="#sliderCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
          </button>
          <button class="carousel-control-next" type="button" data-bs-target="#sliderCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
          </button>
        </div>
        <!-- Sticky tools bar for mobile -->
        <div class="tools-bar d-flex justify-content-start align-items-center gap-2 flex-wrap px-2 py-2 bg-light">
          {% for tool in tools %}
          <button data-name="{{ tool.name }}" class="btn-tool btn btn-sm btn-outline-dark text-nowrap">
            <i class="bi {{ tool.icon }}"></i> {{ tool.label }}
          </button>
          {% endfor %}
          <button class="btn btn-sm btn-outline-primary text-nowrap" data-bs-toggle="offcanvas"
            data-bs-target="#questionOffcanvas" aria-controls="questionOffcanvas"
            title="Choose a specific question to jump to">
            <i class="bi bi-list-ul"></i> Questions
          </button>
        </div>
      </div>
    </div>
  </div>
  <!-- Bootstrap & JS -->
  <div class="offcanvas offcanvas-end w-100" tabindex="-1" id="questionOffcanvas"
    aria-labelledby="questionOffcanvasLabel">
    <div class="offcanvas-header bg-primary text-white">
      <h5 class="offcanvas-title" id="questionOffcanvasLabel">Select a Question</h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>

    <div class="offcanvas-body p-0">

      <!-- Main questions table (same IDs as desktop for shared JS) -->
      <div class="table-responsive">
        <table class="table table-bordered table-sm mb-0" id="questions-table">
          <thead class="table-light">
            <tr>
              <th>#</th>
              <th>Question</th>
              <th>Marks</th>
              <th>Action</th>
            </tr>
          </thead>
          <tbody></tbody>
          <tfoot></tfoot>
        </table>
      </div>

      <!-- Per-page tools summary table (required by shared JS) -->
      <div class="table-responsive border-top mt-2">
        <table class="table table-bordered table-sm align-middle mb-0" id="sheet-questions-table">
          <thead class="table-light">
            <tr>
              <th data-bs-toggle="tooltip" title="Page Number">Page</th>
              <th data-bs-toggle="tooltip" title="Question Number">Q. No</th>
              <th data-bs-toggle="tooltip" title="Obtained Marks / Total Marks for Question">Marks</th>
              <th data-bs-toggle="tooltip" title="Attempted Status and Bonus">Marks/Text</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <!-- Submit & lock form, mobile-friendly -->
      <div class="bg-light border-top mt-2">
        <form action="" method="post" class="p-2">
          {% csrf_token %}
          <div class="row g-2 align-items-start">
            <div class="col-12">
              <div class="form-check small">
                <input class="form-check-input" type="checkbox" required name="confirm" id="confirmCheckbox">
                <label class="form-check-label" for="confirmCheckbox">
                  I confirm that all information entered is accurate and final. Once submitted, the data will be
                  locked and cannot be edited or reversed.
                </label>s
              </div>
            </div>
            <div class="col-12">
              <button type="submit" id="submitLockBtn" class="btn btn-success w-100">
                <i class="bi bi-lock-fill me-1"></i> Submit &amp; Lock
              </button>
            </div>
          </div>
        </form>
      </div>

    </div>
  </div>

  <!-- Help Modal -->
  <div class="offcanvas offcanvas-end" tabindex="-1" id="helpModal" aria-labelledby="helpOverlayLabel">
    <div class="offcanvas-header bg-info text-white">
      <h5 class="offcanvas-title" id="helpOverlayLabel">
        <i class="bi bi-info-circle-fill"></i> Help & Guide
      </h5>
      <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <h6><i class="bi bi-caret-right-fill text-primary"></i> Navigation</h6>
      <p>Use the pagination to navigate or jump using the Go To box.</p>

      <h6><i class="bi bi-caret-right-fill text-primary"></i> Submitting</h6>
      <p>Click the <strong>Submit All</strong> button when ready to submit your responses.</p>

      <h6><i class="bi bi-caret-right-fill text-primary"></i> Marking Status</h6>
      <ul>
        <li><span class="badge bg-primary">A</span> Attempted</li>
        <li><span class="badge bg-warning text-dark">OA</span> Over Attempted</li>
        <li><span class="badge bg-secondary">NA</span> Not Attempted</li>
        <li><span class="badge bg-light border">NM</span> Not Marked</li>
      </ul>

      <h6><i class="bi bi-caret-right-fill text-primary"></i> Icons Reference</h6>
      <p>
        <i class="bi bi-arrow-counterclockwise text-secondary"></i> Undo <br>
        <i class="bi bi-check-circle text-success"></i> Submit All <br>
        <i class="bi bi-x-circle text-danger"></i> Reset Field
      </p>

      <div class="alert alert-warning mt-4">
        <i class="bi bi-exclamation-triangle"></i> Please review all answers before final submission.
      </div>
    </div>
  </div>

  <!-- Sheets Modal -->
  <div class="modal fade" id="sheetsModal" tabindex="-1" aria-labelledby="sheetsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-primary text-white">
          <h5 class="modal-title" id="sheetsModalLabel">
            <i class="bi bi-grid-3x3-gap me-2"></i>Manage Sheets
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle me-2"></i>
            <strong>How to use:</strong> Click on any sheet image or label to navigate to that page. 
            Use checkboxes to select sheets for bulk marking with the Save button.
          </div>
          
          <!-- Control Buttons -->
          <div class="d-flex gap-2 mb-3">
            <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllSheets">
              <i class="bi bi-check-all"></i> Select All
            </button>
            <button type="button" class="btn btn-sm btn-outline-secondary" id="clearAllSheets">
              <i class="bi bi-x-square"></i> Clear All
            </button>
            <button type="button" class="btn btn-sm btn-success" id="saveSheets">
              <i class="bi bi-save"></i> Save
            </button>
            <button type="button" class="btn btn-sm btn-outline-danger" id="cancelSheets" data-bs-dismiss="modal">
              <i class="bi bi-x-circle"></i> Cancel
            </button>
          </div>

          <!-- Sheets Grid -->
          <div class="sheets-grid" id="sheetsGrid">
            <!-- Sheets will be dynamically loaded here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Submit Entries Modal -->
  <div class="modal fade" id="submitEntriesModal" tabindex="-1" aria-labelledby="submitEntriesModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="submitEntriesModalLabel">
            <i class="bi bi-send me-2"></i>Submit Marks Entries
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="alert alert-info mb-3">
            <i class="bi bi-info-circle me-2"></i>
            <strong>Review your entries:</strong> All marks-related entries from the static table are shown below. 
            Review the marks given and time taken before submitting.
          </div>
          
          <!-- Summary Info -->
          <div class="row mb-3">
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title mb-1">Total Marks Given</h6>
                  <h4 class="text-primary mb-0" id="totalMarksDisplay">0</h4>
                </div>
              </div>
            </div>
            <div class="col-md-6">
              <div class="card bg-light">
                <div class="card-body">
                  <h6 class="card-title mb-1">Time Taken</h6>
                  <h4 class="text-success mb-0" id="timeTakenDisplay">00:00:00</h4>
                </div>
              </div>
            </div>
          </div>

          <!-- Entries Table -->
          <div class="table-responsive">
            <table class="table table-bordered table-sm" id="entriesTable">
              <thead class="table-light">
                <tr>
                  <th>Page</th>
                  <th>Question No</th>
                  <th>Marks Given</th>
                  <th>Tool Used</th>
                </tr>
              </thead>
              <tbody>
                <!-- Entries will be dynamically loaded here -->
              </tbody>
            </table>
          </div>

          <!-- Confirmation Section -->
          <div class="alert alert-warning mt-3">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="confirmCheckbox">
              <label class="form-check-label" for="confirmCheckbox">
                <strong>I confirm that I have reviewed all the entries and they are correct.</strong><br>
                This action will submit the data to backend and store it in CSV file. This cannot be undone.
              </label>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
            <i class="bi bi-x-circle"></i> Cancel
          </button>
          <button type="button" class="btn btn-warning" id="exportCsvBtn">
            <i class="bi bi-download"></i> Export CSV
          </button>
          <button type="button" class="btn btn-danger" id="submitLockBtn" disabled>
            <i class="bi bi-lock"></i> Submit & Lock
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"
    integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <script src="{% static 'script.js' %}"></script>
  <script src="{% static 'magnifier.js' %}"></script>
  
  </body>

</html>