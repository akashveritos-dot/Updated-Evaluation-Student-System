{% extends 'base.html' %}
{% block content %}
<h2>Annotate PDF: {{ pdf.original_name }}</h2>

<div style="margin-bottom: 10px;">
  <button onclick="setDrawMode()">ğŸ–Šï¸ Draw</button>
  <button onclick="setTextMode()">ğŸ”¤ Text</button>
  <button onclick="setSelectMode()">ğŸ–±ï¸ Select</button>
  <button onclick="clearCanvas()">ğŸ—‘ï¸ Clear</button>
  <button onclick="saveAnnotations()">ğŸ’¾ Save</button>
  <br><br>
  <button onclick="prevPage()">â¬…ï¸ Prev Page</button>
  <span>Page: <span id="pageNumberDisplay">1</span></span>
  <button onclick="nextPage()">â¡ï¸ Next Page</button>
</div>

<canvas id="canvas" width="800" height="1100" style="border:1px solid #ccc;"></canvas>

<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
<script>
const canvas = new fabric.Canvas('canvas');
let drawMode = false;
let textMode = false;
let pageNumber = 1;
const pdfId = {{ pdf.id }};
const maxPages = {{ total_pages }};  // Dynamic number of pages based on the images in the directory

function loadPageImage() {
    canvas.clear();
    const imgPath = `/media/pdf_images/pdf_${pdfId}/page_${pageNumber}.jpg`; // Adjust path based on the page number
    fabric.Image.fromURL(imgPath, function(img) {
        canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas), {
            scaleX: canvas.width / img.width,
            scaleY: canvas.height / img.height
        });
        loadAnnotations();
    }, { crossOrigin: 'anonymous' });
}

function setDrawMode() {
    drawMode = true;
    textMode = false;
    canvas.isDrawingMode = true;
}

function setTextMode() {
    drawMode = false;
    textMode = true;
    canvas.isDrawingMode = false;
    canvas.on('mouse:down', function(options) {
        if (textMode && options.pointer) {
            const text = new fabric.IText('Text here', {
                left: options.pointer.x,
                top: options.pointer.y,
                fill: '#000',
                fontSize: 18
            });
            canvas.add(text);
        }
    });
}

function setSelectMode() {
    drawMode = false;
    textMode = false;
    canvas.isDrawingMode = false;
}

function clearCanvas() {
    canvas.getObjects().forEach((obj) => {
        if (!obj.backgroundImage) canvas.remove(obj);
    });
    canvas.renderAll();
}

function saveAnnotations() {
    const actions = canvas.toDatalessJSON().objects;
    fetch('/save-annotation/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
        body: JSON.stringify({ pdf_id: pdfId, page_number: pageNumber, actions: actions })
    })
    .then(res => res.json())
    .then(data => alert(data.status));
}

function loadAnnotations() {
    fetch(`/load-annotation/?pdf_id=${pdfId}&page_number=${pageNumber}`)
    .then(res => res.json())
    .then(data => {
        if (data.status === 'success') {
            canvas.loadFromJSON({ objects: data.actions }, canvas.renderAll.bind(canvas));
        }
    });
}

function prevPage() {
    if (pageNumber > 1) {
        pageNumber--;
        document.getElementById('pageNumberDisplay').textContent = pageNumber;
        loadPageImage();
    }
}

function nextPage() {
    if (pageNumber < maxPages) {
        pageNumber++;
        document.getElementById('pageNumberDisplay').textContent = pageNumber;
        loadPageImage();
    }
}

// Initial load
loadPageImage();
</script>
{% endblock %}
