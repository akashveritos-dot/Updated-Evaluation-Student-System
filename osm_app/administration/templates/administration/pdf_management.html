{% extends 'administration/base_admin.html' %}

{% block content %}
<div class="row g-4">
    <!-- Left: Unified Upload & Assign Form -->
    <div class="col-md-4">
        <div class="card shadow border-0">
            <div class="card-header bg-white py-3">
                <h5 class="card-title mb-0 fw-bold text-primary">
                    <i class="bi bi-cloud-arrow-up-fill me-2"></i>Upload & Assign
                </h5>
            </div>
            <div class="card-body p-4">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="upload_and_assign">

                    <!-- File Input -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Answer Sheet (PDF)</label>
                        <input class="form-control form-control-lg" type="file" name="file" required accept=".pdf">
                        <div class="form-text">Upload the student's answer sheet script</div>
                    </div>

                    <!-- PDF Password -->
                    <div class="mb-4">
                        <label class="form-label">PDF Password <span
                                class="text-muted fw-normal">(Optional)</span></label>
                        <input type="password" name="password" class="form-control" placeholder="If encrypted...">
                    </div>

                    <hr class="my-4 text-muted opacity-25">

                    <!-- Assign to Student -->
                    <div class="mb-3">
                        <label class="form-label fw-bold text-success">Assign to Student</label>
                        <select class="form-select form-select-lg" name="student" required>
                            <option value="">-- Select Student --</option>
                            {% for student in students %}
                            <option value="{{ student.id }}">{{ student.username }} ({{ student.email }})</option>
                            {% endfor %}
                        </select>
                        <div class="form-text text-success">
                            <i class="bi bi-check-circle-fill me-1"></i>Selected student will be auto-activated
                        </div>
                    </div>

                    <!-- Select Paper -->
                    <div class="mb-4">
                        <label class="form-label fw-bold">Question Paper</label>
                        <select class="form-select" name="paper">
                            <option value="">-- No Specific Paper --</option>
                            {% for paper in papers %}
                            <option value="{{ paper.id }}">{{ paper.name }}</option>
                            {% endfor %}
                        </select>
                    </div>

                    <div class="d-grid">
                        <button type="submit" class="btn btn-primary btn-lg">
                            <i class="bi bi-rocket-takeoff-fill me-2"></i>Upload & Assign
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Right: Recent Assignments List -->
    <div class="col-md-8">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-header bg-light py-3 d-flex justify-content-between align-items-center">
                <h5 class="mb-0 text-muted">Recent Assignments</h5>
                <span class="badge bg-secondary">{{ assignments.count }} Records</span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4">Student</th>
                                <th>Assigned File</th>
                                <th>Paper</th>
                                <th>Date</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for assign in assignments %}
                            <tr>
                                <td class="ps-4">
                                    <div class="d-flex align-items-center">
                                        <div class="avatar-sm bg-primary-subtle text-primary rounded-circle d-flex align-items-center justify-content-center me-3"
                                            style="width: 35px; height: 35px;">
                                            {{ assign.student.username|make_list|first|upper }}
                                        </div>
                                        <div>
                                            <div class="fw-bold">{{ assign.student.username }}</div>
                                            <div class="small text-muted">{{ assign.student.email }}</div>
                                        </div>
                                    </div>
                                </td>
                                <td>
                                    <i class="bi bi-file-earmark-pdf text-danger me-1"></i>
                                    {{ assign.pdf.original_name }}
                                </td>
                                <td>
                                    {% if assign.question_paper %}
                                    <span class="badge bg-info-subtle text-info-emphasis">{{ assign.question_paper.name
                                        }}</span>
                                    {% else %}
                                    <span class="text-muted">-</span>
                                    {% endif %}
                                </td>
                                <td class="text-muted small">{{ assign.assigned_at|date:"M d, H:i" }}</td>
                                <td class="text-end pe-4">
                                    <form method="post" class="d-inline"
                                        onsubmit="return confirm('Remove this assignment?');">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete_assignment">
                                        <input type="hidden" name="assignment_id" value="{{ assign.id }}">
                                        <button type="submit" class="btn btn-sm btn-outline-danger border-0">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="5" class="text-center py-5 text-muted">
                                    <i class="bi bi-inbox display-6 d-block mb-3 opacity-50"></i>
                                    No assignments found.
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}